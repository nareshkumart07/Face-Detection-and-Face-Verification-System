
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Face Verification - Live Camera</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Mirror the video to make it feel like a real mirror */
        video { transform: scaleX(-1); }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen font-sans pb-10">

    <!-- Navbar -->
    <nav class="bg-slate-800 border-b border-slate-700 p-4 sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-blue-400"><i class="fas fa-id-badge mr-2"></i>FaceAuth</h1>
            <div class="text-xs md:text-sm text-slate-400 font-mono" id="api-status">Connecting...</div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-6 max-w-3xl">
        
        <!-- Tabs -->
        <div class="flex mb-6 bg-slate-800 rounded-lg p-1 shadow-md">
            <button onclick="switchTab('register')" id="tab-register" class="flex-1 py-3 rounded-md bg-blue-600 transition-all font-bold text-sm md:text-base">Register</button>
            <button onclick="switchTab('verify')" id="tab-verify" class="flex-1 py-3 rounded-md hover:bg-slate-700 transition-all text-slate-300 font-bold text-sm md:text-base">Verify</button>
        </div>

        <!-- Camera Container (Shared) -->
        <!-- CHANGED: h-80 for mobile (taller), aspect-video for desktop (wider) -->
        <div class="bg-black rounded-2xl overflow-hidden shadow-2xl border-2 border-slate-700 relative mb-6 h-80 md:h-auto md:aspect-video mx-auto">
            <video id="video" class="w-full h-full object-cover" autoplay playsinline muted></video>
            <canvas id="canvas" class="hidden"></canvas>
            
            <!-- Camera Overlay UI -->
            <div class="absolute bottom-4 left-0 right-0 flex justify-center gap-4 z-10">
                <button onclick="startCamera()" id="btn-start-cam" class="bg-slate-700/80 backdrop-blur-sm hover:bg-slate-600 text-white px-6 py-2 rounded-full text-sm font-semibold shadow-lg border border-slate-500">
                    <i class="fas fa-video mr-1"></i> Start Camera
                </button>
            </div>
            
            <!-- Face Frame Guide (Visual only) -->
            <div class="absolute inset-0 pointer-events-none flex items-center justify-center opacity-30">
                <div class="w-48 h-64 border-2 border-white rounded-3xl border-dashed"></div>
            </div>
        </div>

        <!-- Register Controls -->
        <div id="section-register" class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700">
            <h2 class="text-2xl font-bold mb-4">Register User</h2>
            <form onsubmit="handleRegister(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1 text-slate-300">Full Name</label>
                    <input type="text" id="reg-name" required placeholder="Enter person's name" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 focus:border-blue-500 focus:outline-none transition-colors text-lg placeholder-slate-600">
                </div>
                
                <button type="submit" id="btn-register" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-bold text-lg shadow-lg transition-transform active:scale-95 flex justify-center items-center gap-2">
                    <i class="fas fa-camera"></i> Capture & Register
                </button>
            </form>
            <div id="reg-result" class="mt-4 hidden p-3 rounded-lg text-center font-semibold"></div>
        </div>

        <!-- Verify Controls -->
        <div id="section-verify" class="hidden bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700">
            <h2 class="text-2xl font-bold mb-4">Verify Identity</h2>
            <p class="text-slate-400 mb-4">Center your face in the frame and tap verify.</p>
            
            <button onclick="handleVerify()" id="btn-verify" class="w-full bg-green-600 hover:bg-green-500 py-4 rounded-xl font-bold text-lg shadow-lg transition-transform active:scale-95 flex justify-center items-center gap-2">
                <i class="fas fa-fingerprint"></i> Capture & Verify
            </button>

            <!-- Verify Result Card -->
            <div id="ver-result" class="mt-6 hidden transition-all">
                <div class="bg-slate-900 rounded-lg p-6 border border-slate-700 flex flex-col items-center gap-3 text-center">
                    <div id="ver-icon" class="w-20 h-20 rounded-full flex items-center justify-center text-4xl font-bold shadow-inner mb-2"></div>
                    <div>
                        <h3 id="ver-name" class="text-2xl font-bold"></h3>
                        <p id="ver-sim" class="text-slate-400 font-mono mt-1 text-sm"></p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        let stream = null;

        // Check API Status
        fetch('/health')
            .then(res => res.json())
            .then(data => document.getElementById('api-status').innerHTML = `<span class="text-green-400 flex items-center gap-1"><span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span> Online</span>`)
            .catch(() => document.getElementById('api-status').innerHTML = `<span class="text-red-400 flex items-center gap-1"><span class="w-2 h-2 bg-red-400 rounded-full"></span> Offline</span>`);

        // Initialize Camera
        async function startCamera() {
            try {
                // Request a resolution that works well on mobile portrait (tall) or desktop (wide)
                const constraints = { 
                    video: { 
                        facingMode: "user",
                        width: { ideal: 1280 }, 
                        height: { ideal: 720 }
                    } 
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                document.getElementById('btn-start-cam').classList.add('hidden');
            } catch (err) {
                console.error("Camera Error:", err);
                alert("Could not access camera. Please ensure you are using HTTPS and have granted camera permissions.");
            }
        }
        
        // Start camera on load
        startCamera();

        function switchTab(tab) {
            document.querySelectorAll('[id^="section-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`section-${tab}`).classList.remove('hidden');
            
            document.getElementById('tab-register').classList.toggle('bg-blue-600', tab === 'register');
            document.getElementById('tab-register').classList.toggle('text-slate-300', tab !== 'register');
            
            document.getElementById('tab-verify').classList.toggle('bg-green-600', tab === 'verify');
            document.getElementById('tab-verify').classList.toggle('text-slate-300', tab !== 'verify');
            
            // Clear results
            document.getElementById('reg-result').classList.add('hidden');
            document.getElementById('ver-result').classList.add('hidden');
        }

        function captureImage() {
            if (!stream) {
                alert("Camera not active");
                return null;
            }
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            return new Promise(resolve => {
                canvas.toBlob(resolve, 'image/jpeg', 0.85);
            });
        }

        async function handleRegister(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-register');
            const originalHTML = btn.innerHTML;
            
            try {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                btn.disabled = true;

                const blob = await captureImage();
                if (!blob) throw new Error("Failed to capture image");

                const formData = new FormData();
                formData.append('name', document.getElementById('reg-name').value);
                formData.append('file', blob, 'capture.jpg');

                const res = await fetch('/register', { method: 'POST', body: formData });
                const data = await res.json();
                
                const resultDiv = document.getElementById('reg-result');
                resultDiv.classList.remove('hidden');
                
                if (res.ok) {
                    resultDiv.className = "mt-4 p-4 rounded-lg text-center bg-green-900/50 text-green-200 border border-green-700 shadow";
                    resultDiv.innerHTML = `<i class="fas fa-check-circle text-xl mb-1"></i><br>${data.message}`;
                    document.getElementById('reg-name').value = '';
                } else {
                    throw new Error(data.detail || "Registration failed");
                }
            } catch (err) {
                const resultDiv = document.getElementById('reg-result');
                resultDiv.classList.remove('hidden');
                resultDiv.className = "mt-4 p-4 rounded-lg text-center bg-red-900/50 text-red-200 border border-red-700 shadow";
                resultDiv.innerHTML = `<i class="fas fa-exclamation-triangle text-xl mb-1"></i><br>${err.message}`;
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        async function handleVerify() {
            const btn = document.getElementById('btn-verify');
            const originalHTML = btn.innerHTML;
            
            try {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
                btn.disabled = true;

                const blob = await captureImage();
                if (!blob) throw new Error("Failed to capture image");

                const formData = new FormData();
                formData.append('file', blob, 'verify.jpg');

                const res = await fetch('/verify', { method: 'POST', body: formData });
                const data = await res.json();
                
                const resultDiv = document.getElementById('ver-result');
                const iconDiv = document.getElementById('ver-icon');
                const nameEl = document.getElementById('ver-name');
                const simEl = document.getElementById('ver-sim');
                
                resultDiv.classList.remove('hidden');

                if (res.ok && data.match) {
                    iconDiv.className = "w-20 h-20 rounded-full flex items-center justify-center text-4xl font-bold bg-green-500 text-white shadow-lg mb-2";
                    iconDiv.innerHTML = '<i class="fas fa-check"></i>';
                    nameEl.innerText = `${data.person}`;
                    nameEl.className = "text-2xl font-bold text-green-400";
                    simEl.innerText = `Confidence: ${(data.similarity * 100).toFixed(1)}%`;
                    resultDiv.querySelector('div').className = "bg-green-900/20 rounded-lg p-6 border border-green-600 flex flex-col items-center gap-2";
                } else {
                    iconDiv.className = "w-20 h-20 rounded-full flex items-center justify-center text-4xl font-bold bg-red-500 text-white shadow-lg mb-2";
                    iconDiv.innerHTML = '<i class="fas fa-times"></i>';
                    nameEl.innerText = "Unknown Person";
                    nameEl.className = "text-2xl font-bold text-red-400";
                    simEl.innerText = data.match === false ? `Best Match: ${(data.similarity * 100).toFixed(1)}% (Too Low)` : (data.detail || "Error");
                    resultDiv.querySelector('div').className = "bg-red-900/20 rounded-lg p-6 border border-red-600 flex flex-col items-center gap-2";
                }
            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
